name: PR Preview Deploy to S3 and CloudFront

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest

    env:
      BUCKET_NAME: starsync
      VITE_BASE_URL: ${{ secrets.VITE_BASE_URL }}

    steps:
    - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      uses: actions/checkout@v4

    - name: Node.js í™˜ê²½ ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: 22.14.0

    - name: ì˜ì¡´ì„± ì„¤ì¹˜ (npm ci)
      run: npm ci

    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ (Vite)
      run: npm run build

    - name: AWS ì¸ì¦ ì •ë³´ ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Preview S3 ì—…ë¡œë“œ (PR ë²ˆí˜¸ ê¸°ì¤€)
      run: |
        PREVIEW_PATH="preview/pr-${{ github.event.pull_request.number }}"
        echo "Preview ê²½ë¡œ: s3://$BUCKET_NAME/$PREVIEW_PATH/"
        aws s3 sync dist/ s3://$BUCKET_NAME/$PREVIEW_PATH/ --delete

    - name: PRì— Preview ë§í¬ ë‚¨ê¸°ê¸°
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        message: |
          ğŸš€ **PR Preview ë°°í¬ ì™„ë£Œ!**
          ğŸ”— [Preview í™•ì¸í•˜ê¸°](https://preview.starsync.wiki/preview/pr-${{ github.event.pull_request.number }})